---
title: "impact of leaked treamtent effect, within the background of biexponential models"
author: "wei zou"
date: "`r Sys.time()`"
output: pdf_document
---

version history:

2d: try a smaller range of Ks_trt, the higher end

2c: try a smaller range of Ks_trt, the lower end

 


Output is generated by `r knitr::current_input()` at `r getwd()` from `r R.version.string`.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)


spec <- list( home = '~/aPDL1/oak', job  = 'change_all3_2d_ks_kg0.01',batchSize = 20, seedBase=27519, numValidation = 5, duplicates_for_meta_regression=3)

spec$totalIter <- (1 + spec$numValidation) * spec$batchSize * 2.5

library(knitr)
library(plyr)
library(ggplot2)
library(reshape2)
source('~/R/lib_2020/data_functions.r')
source('~/R/lib_2020/output_functions.r')
source('~/R/lib_2020/yyboxplot.r')
source('~/R/lib_2020/violin.r')
source('~/aPDL1/oak/simsurv_functions.r')
```

```{r sim, eval=F, include=F}
# this section is submitted interactively

spec$logHome  =  with(spec, paste(home, 'log', job, sep='/'))
spec$resHome =   with(spec, paste(home, 'results', job, sep='/'))

for (e in c(spec$logHome, spec$resHome)) {
  if (!file.exists(e)){
    dir.create(e, recursive =T)
  } 
}

for (a in c(0, 0.5, 2, 4, 6)){
for (g in seq(0.04,0.06,length.out=5)){ #ks_trt
  for (b1 in c(0, -0.3, -0.6)){
  for (b in 1:with(spec, ceiling(totalIter/batchSize))){
    f_root <- paste(a, b1, g, b, sep ='_')
    cmd_file <- paste(spec$logHome, '/cmd_',f_root,'.log', sep = '')
cat(
"#!/bin/bash
#SBATCH -J",spec$job,"
#SBATCH --qos=short
#SBATCH --cpus-per-task 1
#SBATCH --mem-per-cpu=4G

ml R/R_3.6.1_Bioc_3.10/R-3.6.1-Bioc-3.10-prd-20200217

R CMD BATCH   --no-save --no-restore '--args alpha,ks_trt,betaEvent_trt ", paste(a,g,b1, sep=','), spec$seedBase + spec$batchSize * (b-1), spec$batchSize, spec$job, "'", 
paste(spec$home, 'sim_unit3d_kg0.01.r', sep='/'), 
paste(spec$logHome, '/run_',f_root,'.log', sep = ''), file = cmd_file)
system(paste('sbatch', cmd_file))

  }}}}
```

```{r load sim results, echo=F}
r1 <- readFolder.rdata( path= paste(spec$home,'results', spec$job, sep='/'), pattern = paste( '\\.Rdata', sep=''), extractPos =c(alpha=6, ks_trt = 7,beta1 = 8), objName ='s1')
 
print('# of simulations per parameter setting')
with(r1, table(alpha, ks_trt, beta1))

```

# operational statictis

```{r, echo=T}
with(r1, tapply(max_fup, list(alpha, ks_trt, beta1), mean))
with(r1, round(tapply(n_early_event.0, list(alpha, ks_trt, beta1), mean)/200,3))
with(r1, round(tapply(n_early_event.1, list(alpha, ks_trt, beta1), mean)/200,3))

print('average PD effect')
with(r1, round(tapply(bm_diff.1, list(alpha, ks_trt, beta1), mean),3))

```


# In-depth analysis for Model performance metrics

```{r}

r1$beta1 <- factor(as.numeric(r1$beta1))
print( myScatter(r1, x='c_rfs_trt1', y='c_rfs_trt0', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)'))

print( myScatter(r1, x='c_rfs_trt1', y='c_rfs_trt0', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)')+ geom_abline(intercept = 0, slope = 1))

print( myScatter(r1, x='ibs_trt1.original', y='ibs_trt0.original', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)') + theme(axis.text.x = element_text(angle = -45)))

print( myScatter(r1, x='ibs_trt1.original', y='ibs_trt0.original', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)') + theme(axis.text.x = element_text(angle = -45))+ geom_abline(intercept = 0, slope = 1))

print( myScatter(r1, x='ibs_trt1.scaled', y='ibs_trt0.scaled', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)') + theme(axis.text.x = element_text(angle = -45)))

print( myScatter(r1, x='ibs_trt1.scaled', y='ibs_trt0.scaled', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)') + theme(axis.text.x = element_text(angle = -45))+ geom_abline(intercept = 0, slope = 1))

print( myScatter(r1, x='ibs.scaled', y='ibs.original', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)') + theme(axis.text.x = element_text(angle = -45)) )

print( myScatter(r1, x='ibs.scaled', y='ibs_strata.scaled2', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)') + theme(axis.text.x = element_text(angle = -45)) )

 myScatter(r1, x='c_rfs', y='unoC', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics in each arm by ks(trt) (columns) and beta1 (rows)')


```

# Model performance metrics are similar given a alpha while ks_trt varies


```{r}

print( myScatter(r1, x='c_rfs', y='ibs.original', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics by ks(trt) (columns) and beta1 (rows)') + xlab('C index') + ylab('IBS'))

 tab1 <- t( sapply(split(r1, list(r1$alpha, r1$beta1, r1$ks_trt)), function(x) {
 
    with(x, c(beta1=unique(as.numeric(as.character(beta1))), 
              alpha=unique(as.numeric(as.character(alpha))),
              ks_trt=as.numeric(unique(ks_trt)), 
              ibs=cor(ibs.original, c_rfs, method = 'spearman'), 
              ibs.scaled=cor(ibs.scaled, c_rfs, method = 'spearman'), 
              beta = cor(bmHR_stratifi_by_trt.bm,c_rfs, method = 'spearman'), n=nrow(x) ))
    }    ))
 
 write.csv(tab1, file = paste(spec$home, '/results/', spec$job,'_correlation_patient_level_stats.csv', sep=''), row.names=F)

#print( myScatter(r1, x='c_rfs', y='ibs.original', col.var = 'beta1', showContour = T) +theme_bw() + facet_grid( ks_trt ~ alpha, scales = 'free') + ggtitle ('performance metrics by alpha (columns) and ks(trt) (rows)'))


print( myScatter(r1, x='c_rfs', y='ibs.scaled', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics by ks(trt) (columns) and beta1 (rows)')+ xlab('C index') + ylab('Scaled IBS'))

#print( myScatter(r1, x='c_rfs', y='ibs.scaled', col.var = 'beta1', showContour = T) +theme_bw() + facet_grid( ks_trt ~ alpha, scales = 'free') + ggtitle ('performance metrics by alpha (columns) and ks(trt) (rows)'))


print( myScatter(r1, x='c_rfs', y='bmHR_stratifi_by_trt.bm', col.var = 'beta1') +theme_bw() + facet_grid( ks_trt ~ alpha) + ggtitle ('performance metrics by alpha (columns) and ks(trt) (rows)') + xlab('C index') + ylab('SE log(HR)'))

print( myScatter(r1, x='ibs.original', y='ibs.scaled', col.var = 'alpha') +theme_bw() + facet_grid(beta1~ks_trt) + ggtitle ('performance metrics by ks(trt) (columns) and beta1 (rows)') + xlab('IBS') + ylab('Scaled IBS'))

col1 <- gplots::colorpanel(n=length(unique(r1$alpha)), low='green', mid='black', high='red')

names(col1) <- unique(r1$alpha)

#print( violinPlot(r1, x ='alpha', y='c_rfs', ylab='C index', h.facets='beta1', add.n='', main='C index distribution by alpha and beta1', col=col1) )


print( yyboxplot(r1, x='alpha', y='c_rfs', x.sub='beta1', ylab='C index', main='C index distribution by alpha and beta1', add.n=F, pch=NA) )

kable( dcast(ddply(r1, .(alpha, beta1) ,function(x) median(x$c_rfs)), alpha~ beta1, value.var='V1'), digits = 2, caption='median C index across all simulated studies')

#print( violinPlot(r1, x ='alpha', y='ibs.original', ylab='IBS', h.facets='beta1', add.n='', main='IBS distribution by alpha and beta1', col=col1) )

print( yyboxplot(r1, x='alpha', y='ibs.original', x.sub='beta1', ylab='IBS', main='IBS distribution by alpha and beta1', add.n=F, pch=NA) )

kable( dcast(ddply(r1, .(alpha, beta1) ,function(x) median(x$ibs.original)), alpha~ beta1, value.var='V1'), digits = 2, caption='median IBS across all simulated studies')


#print(violinPlot(r1, x ='alpha', y='bmHR_stratifi_by_trt.bm', ylab='SE log(HR)', h.facets='beta1', add.n='', main='SE log(HR) distribution by alpha and beta1', col=col1) )

print( yyboxplot(r1, x='alpha', y='bmHR_stratifi_by_trt.bm', x.sub='beta1', ylab='SE log(HR)', main='SE log(HR) distribution by alpha and beta1', add.n=F, pch=NA) )

kable( dcast(ddply(r1, .(alpha, beta1) ,function(x) median(x$'bmHR_stratifi_by_trt.bm')), alpha~ beta1, value.var='V1'), digits = 2, caption='median SE log(HR) index across all simulated studies')

```

```{r distriubtion by alpha, echo=F, eval=F}

multiDensity(split(r1$c_rfs, r1$alpha), legPos = 'topright', title_text =  'distribution by alpha', xlab = 'c index')

multiDensity(split(r1$ibs.original, r1$alpha), legPos = 'topright', title_text =  'distribution by alpha', xlab = 'IBS')

multiDensity(split(r1$ibs.scaled, r1$alpha), legPos = 'topright', title_text =  'distribution by alpha', xlab = 'IBS')

multiDensity(split(r1$bmHR_stratifi_by_trt.bm, r1$alpha), legPos = 'topright', title_text =  'distribution by alpha', xlab = 'beta (biomarker logHR)')


```


 

```{r distribution by beta1, echo=F ,eval=F}
 

l1 <- lapply(unique(r1$alpha), function(a) {
  r2 <- subset(r1, alpha ==a)
multiDensity(split(r2$c_rfs, r2$beta1), legPos = 'topright', title_text =  paste('alpha=', a), xlab = 'c index')

multiDensity(split(r2$ibs.original, r2$beta1), legPos = 'topright', title_text =  paste('alpha=', a), xlab = 'IBS')


multiDensity(split(r2$bmHR_stratifi_by_trt.bm, r2$beta1), legPos = 'topright', title_text =  paste('alpha=', a), xlab = 'beta (biomarker logHR)')

})
```

## distribution by PD modulation  

```{r, echo = F}

print( myScatter(r1, x='c_rfs', y='ibs.original', col.var = 'ks_trt') +theme_bw() + facet_grid(beta1~alpha) + ggtitle ('performance metrics are similar when PD modulations vary'))

multiDensity(split(r1$c_rfs, r1$ks_trt), legPos = 'topright', title_text =  'distribution by PD modulation', xlab = 'c index')

multiDensity(split(r1$ibs.original, r1$ks_trt), legPos = 'topright', title_text =  'distribution by PD modulation', xlab = 'IBS')

multiDensity(split(r1$bmHR_stratifi_by_trt.bm, r1$ks_trt), legPos = 'topright', title_text =  'distribution by PD modulation', xlab = 'beta (biomarker logHR)')

with(r1, stopifnot(!any(duplicated(paste(seed, ks_trt, beta1, alpha)))))
 

#all treatment effect is identical when alpha == 0
#with(subset(r1, alpha == 0), summary(tapply(trt_itt.trt, seed, sd)))


```


 
# overall correlation

```{r, echo=F}
 
print(  ggplot(r1, aes(bm_diff.1, trt_itt.trt)) + geom_hex() + facet_grid(beta1~ alpha) + theme_bw() + ggtitle('meta regression by alpha (cols) and beta (rows)') )

myScatter(r1, x='bm_diff.1', y='trt_itt.trt', col.var = 'beta1', showContour = T) +theme_bw() + facet_wrap( ~alpha, scales = 'free') + ggtitle ('meta regression by alpha')

  co1 <- t(sapply(split(r1, list(r1$alpha, r1$beta1)), function(d) with(d, c(cindex=median(c_rfs), ibs=median(ibs.original),ibs.scaled=median(ibs.scaled), beta=median(bmHR_stratifi_by_trt.bm), r2=cor(bm_diff.1, trt_itt.trt)^2, n=nrow(d), alpha=as.numeric(unique(alpha)), beta1=unique(as.numeric(as.character(beta1)))))))
  
  kable(dcast(as.data.frame(co1), alpha~beta1, value.var='r2'), caption ='SE utility changes with alpha (rows) and beta1 (columns). R2 summarized across seed and PD modulation', digits = 2)
  
  
  co2 <- t(sapply(split(r1, list(r1$alpha)), function(d) with(d, c(r2=cor(bm_diff.1, trt_itt.trt)^2, n=nrow(d), alpha=as.numeric(unique(alpha))))))
  
  kable( as.data.frame(co2),  caption ='SE utility changes with alpha. R2 summarized across beta1, seed and PD modulation', digits = 2)
  
#ggplot(r1, aes(bm_diff.1, trt_itt.trt)) + geom_point(aes(col=ifelse(seed < 27524, as.character(seed), 'Other'), alpha=ifelse(seed < 27524, 1, 0.2) )) + facet_wrap(~ alpha, scales = "free_y") +  theme_bw() + ggtitle ('checking a few seeds') + theme(legend.position="bottom")




```

# SE utility given one value of alpha and beta1
 

```{r,echo=F}

#p1 <- pair_simulation2(ds =r1,  pd_mod.var  ='bm_trt', dup = 1, strata.var=c('alpha','beta1'), returnSimData=F, verbose = 1 ) 
r1$beta1 <- as.character(r1$beta1)
s6  <- pair_simulation2(ds =r1,  pd_mod.var  ='ks_trt', dup = spec$duplicates_for_meta_regression, strata.var=c('alpha','beta1'), returnSimData=T, verbose = 1 ) 

    set.seed(27519)
s5 <- do.call(rbind, lapply(1:100, function(i) pair_simulation2 (ds=r1, pd_mod.var  ='ks_trt')))

    set.seed(27519)
s7 <- do.call(rbind, lapply(1:100, function(i) pair_simulation2 (ds=r1, pd_mod.var  ='ks_trt', dup=spec$duplicates_for_meta_regression )))

``` 

## 1 duplicate

```{r, echo=F}   
   #print(paste('excluding', sum(s5[, 'n'] < 5),'simulations without all bm_trt values'))
s5 <- data.frame(s5)
s5$R2 <- s5$cor1^2
#s5$beta1 <- as.factor(as.numeric(as.character(s5$beta1)))

   s5b <- subset(as.data.frame(s5), n ==5)
   s5b$alpha <- factor(s5b$alpha)
   
   kable( t( sapply(split(s5b, s5b$beta1), function(x) {
    
    with(x, c(beta1=unique(as.numeric(as.character(beta1))), cindex=cor(R2, c_rfs, method = 'spearman'), ibs=cor(R2, ibs, method = 'spearman'), ibs.scaled=cor(R2, ibs.scaled, method = 'spearman'), beta = cor(R2, beta, method = 'spearman'), n=nrow(x) ))
    }
    ) ), caption='Spearman correlation between R2 and various patient level association; by beta1; dup=1', digits = 2, row.names=F)
   
   kable( dcast(ddply(s5b, .(alpha, beta1) ,function(x) median(x$'R2')), alpha~ beta1, value.var='V1'), digits = 2, caption='median R2 across all simulated trial sets')
   
   print( myScatter(s5b, x= 'R2', y ='c_rfs', col.var = 'alpha', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('C index') + facet_wrap('beta1') )
   print( myScatter(s5b, x= 'R2', y ='c_rfs', col.var = 'alpha', corMethod='spearman', showContour = T) + theme_bw() + xlab('SE Utility (R2)') + ylab('C index') + facet_wrap('beta1') )
   
   print( myScatter(s5b, x= 'R2', y ='ibs', col.var = 'alpha', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('beta1'))
  print( myScatter(s5b, x= 'R2', y ='ibs', col.var = 'alpha', corMethod='spearman', showContour = T) + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('beta1'))

     print( myScatter(s5b, x= 'R2', y ='ibs.scaled', col.var = 'alpha', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('beta1'))
  print( myScatter(s5b, x= 'R2', y ='ibs.scaled', col.var = 'alpha', corMethod='spearman', showContour = T) + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('beta1'))

    
   print( myScatter(s5b, x= 'R2', y ='beta', col.var = 'alpha', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('biomarker log(HR)')+ facet_wrap('beta1') )
print( myScatter(s5b, x= 'R2', y ='beta', col.var = 'alpha', corMethod='spearman', showContour = T) + theme_bw() + xlab('SE Utility (R2)') + ylab('biomarker log(HR)')+ facet_wrap('beta1') )
   
s5b$beta1 <- factor(s5b$beta1)
   print( myScatter(s5b, x= 'R2', y ='c_rfs', col.var = 'beta1', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('C index') + facet_wrap('alpha') )
   
   print( myScatter(s5b, x= 'R2', y ='ibs', col.var = 'beta1', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('alpha'))
  
    myScatter(s5b, x= 'R2', y ='beta', col.var = 'beta1', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('biomarker log(HR)')+ facet_wrap('alpha')  
    
    
 
```

```{r}
  violinPlot(s5b, x= 'beta1', y = 'intercept', v.facets='alpha', xlab='leaked treatment effect (beta1)')

 
   
```


## 3 replicates

```{r repeat with dup equal to 3, echo =F}
   #print(paste('excluding', sum(s5[, 'n'] < 5),'simulations without all bm_trt values'))
s7 <- data.frame(s7)
s7$R2 <- s7$cor1^2

kable( t( sapply(split(s7, s7$beta1), function(x) {
    
    with(x, c(beta1=unique(as.numeric(as.character(beta1))), cindex=cor(R2, c_rfs, method = 'spearman'), ibs=cor(R2, ibs, method = 'spearman'), ibs.scaled=cor(R2, ibs.scaled, method = 'spearman'), beta = cor(R2, beta, method = 'spearman'), n=nrow(x) ))
    }
    ) ), caption=paste( 'Spearman correlation with various patient level association; by beta1; dup=', spec$duplicates_for_meta_regression ), digits = 2, row.names=F)   

   s7$alpha <- factor(s7$alpha)
   
   yyboxplot(s7, x='alpha', y='R2', x.sub='beta1', ylab='R2 for trial level association', add.n=F, pch=NA) 

kable( dcast(ddply(s7, .(alpha, beta1) ,function(x) median(x$'R2')), alpha~ beta1, value.var='V1'), digits = 2, caption='median R2 across all simulated trial sets')
   
#   print( violinPlot(s7, x = 'alpha',y='R2', h.facets = 'beta1', add.n='', ylab='R2 for trial level association', col=col1) )
   
   print( myScatter(s7, x= 'R2', y ='c_rfs', col.var = 'alpha', corMethod='spearman',  main = '3 replicates per PD modulation') + theme_bw() + xlab('SE Utility (R2)') + ylab('C index') + facet_wrap('beta1') )
   
   print( myScatter(s7, x= 'R2', y ='c_rfs', col.var = 'alpha', corMethod='spearman', showContour = T, main = '3 replicates per PD modulation') + theme_bw() + xlab('SE Utility (R2)') + ylab('C index') + facet_wrap('beta1') )
   
   
   print( myScatter(s7, x= 'R2', y ='ibs', col.var = 'alpha', corMethod='spearman',  main = '3 replicates per PD modulation') + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('beta1') )
   
   print( myScatter(s7, x= 'R2', y ='ibs', col.var = 'alpha', corMethod='spearman',  main = '3 replicates per PD modulation', showContour = T) + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('beta1') )

   
      print( myScatter(s7, x= 'R2', y ='ibs.scaled', col.var = 'alpha', corMethod='spearman',  main = '3 replicates per PD modulation') + theme_bw() + xlab('SE Utility (R2)') + ylab('Scaled IBS') + facet_wrap('beta1') )
   
   print( myScatter(s7, x= 'R2', y ='ibs.scaled', col.var = 'alpha', corMethod='spearman',  main = '3 replicates per PD modulation', showContour = T) + theme_bw() + xlab('SE Utility (R2)') + ylab('Scaled IBS') + facet_wrap('beta1') )

      
   print( myScatter(s7, x= 'R2', y ='beta', col.var = 'alpha', corMethod='spearman',  main = '3 replicates per PD modulation') + theme_bw() + xlab('SE Utility (R2)') + ylab('biomarker log(HR)') + facet_wrap('beta1') )
   
   print( myScatter(s7, x= 'R2', y ='beta', col.var = 'alpha', corMethod='spearman',  main = '3 replicates per PD modulation', showContour = T) + theme_bw() + xlab('SE Utility (R2)') + ylab('biomarker log(HR)') + facet_wrap('beta1') )
   
   s7$beta1 <- factor(s7$beta1)
   print( myScatter(s7, x= 'R2', y ='c_rfs', col.var = 'beta1', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('C index') + facet_wrap('alpha') )
   print( myScatter(s7, x= 'R2', y ='ibs', col.var = 'beta1', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('IBS') + facet_wrap('alpha'))
  
    myScatter(s7, x= 'R2', y ='beta', col.var = 'beta1', corMethod='spearman') + theme_bw() + xlab('SE Utility (R2)') + ylab('biomarker log(HR)')+ facet_wrap('alpha')  
```

correlations are calculated across the entire sample, not stratified.

```{r}
  violinPlot(s7, x= 'beta1', y = 'intercept', v.facets='alpha', xlab='leaked treatment effect (beta1)')
   
```



```{r example data 1, echo=F}
 
ggplot(s6, aes(bm_diff.1, trt_itt.trt)) + geom_point(aes(col=ks_trt)) + scale_color_manual(values= rainbow(length(unique(s6$ks_trt)))) + facet_grid( beta1~ alpha) + theme_bw() + ggtitle('one set of simulations,stratified by alpha and beta1') + xlab('marginal SE difference across treatment') + ylab('marginal treatment effect') 

```

each small panel above is a separate random sample

# SE utility summarized across beta1 given alpha


```{r, echo=F}

s4  <- pair_simulation2(ds =r1,  pd_mod.var  =c('ks_trt', 'beta1'), dup = 1, strata.var=c('alpha'), returnSimData=T, verbose = 1 ) 

    set.seed(27519)
s3 <- do.call(rbind, lapply(1:100, function(i) pair_simulation2 (ds=r1, pd_mod.var  =c('ks_trt', 'beta1'), dup = 1, strata.var=c('alpha'))))


   s3 <- as.data.frame(s3)
   s3$R2 <- s3$cor1^2
  s3$alpha <- as.character(s3$alpha)
  print( myScatter(s3,  x = 'R2' ,  y='c_rfs', col.var = 'alpha', corMethod='spearman') + xlab('SE Utility') + ylab('C index') + theme_bw() )
  print( myScatter(s3,  x = 'R2' ,  y='c_rfs', col.var = 'alpha', corMethod='spearman', showContour = T) + xlab('SE Utility') + ylab('C index') + theme_bw() )
  
  print( myScatter(s3,  x = 'R2' ,  y='ibs', col.var = 'alpha', corMethod='spearman') + xlab('SE Utility') + ylab('IBS') + theme_bw() )
    print( myScatter(s3,  x = 'R2' ,  y='ibs', col.var = 'alpha', corMethod='spearman',showContour = T) + xlab('SE Utility') + ylab('IBS') + theme_bw() )
    
  print(myScatter(s3,  x = 'R2' ,  y='beta', col.var = 'alpha', corMethod='spearman') + xlab('SE Utility') + ylab('biomarker log(HR)') + theme_bw())
  
  print( myScatter(s3,  x = 'R2' ,  y='beta', col.var = 'alpha', corMethod='spearman',showContour = T) + xlab('SE Utility') + ylab('biomarker log(HR)') + theme_bw())
  
```


```{r example 2, echo=F}

s4$beta1 <- factor(s4$beta1)

ggplot(s4, aes(bm_diff.1, trt_itt.trt)) + geom_point(aes(col=beta1)) + facet_wrap(~alpha)+ theme_bw() + ggtitle('one set of simulations, grouped by alpha') + xlab('marginal SE difference across treatment') + ylab('marginal treatment effect') 

```



```{r save simulations, echo=F}

s_b <- s3

s_1 <- s5
s_3 <- s7

save( s_b, s_1, s_3, file= paste(spec$home, '/results/', spec$job,'_simu_result.Rdata', sep=''), version=2)

```